<div class="bg-light min-vh-100 py-3">
  <div class="container">
    <div class="bg-white shadow rounded p-4 position-relative" style="padding-top: 4rem;">
      
      <!-- Botón Favorito -->
      <div class="position-absolute top-0 end-0 m-2 p-2" style="z-index: 10;">
        <button (click)="toggleFavorite()" 
                [class.favorited]="isFavorite"
                class="btn btn-link p-0"
                aria-label="Agregar a favoritos"
                style="font-size: 1.8rem; line-height: 1;">
          <i class="bi" [ngClass]="isFavorite ? 'bi-heart-fill text-danger' : 'bi-heart'"></i>
        </button>
      </div>

      <!-- Fila superior: Carrusel + Información -->
      <div class="row">
        <!-- Carrusel -->
        <div class="col-md-4 mb-2 d-flex justify-content-center">
          <div id="carouselImages" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner rounded">
              <div
                class="carousel-item"
                [class.active]="i === 0"
                *ngFor="let img of publication.images; let i = index"
              >
                <div class="zoom-wrapper"
                     (mousemove)="zoomImage($event)"
                     (mouseleave)="resetZoom()"
                     style="position: relative; overflow: hidden;">
                  <img
                    [src]="img"
                    class="zoom-img"
                    #zoomedImg
                    alt="Imagen de publicación"
                    style="aspect-ratio: 1/1; object-fit: cover; cursor: zoom-in;"
                    (click)="openImage(img)"
                  />
                </div>
              </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselImages" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselImages" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
        </div>

        <!-- Información de la publicación -->
        <div class="col-md-8 mb-6">
          <div class="d-flex align-items-center mb-2">
            <h4 class="mb-0">{{ publication.title }}</h4>
          </div>

          <div class="mb-2 mt-3">
            <span *ngFor="let tag of publication.tags" [ngClass]="getTagClass(tag)" class="badge me-1">
              {{ tag }}
            </span>
          </div>

          <h2 class="text mb-3">$ {{ publication.price | decimalFormat }}</h2>

          <p class="text-secondary mb-1">
            <i class="bi bi-geo-alt me-1"></i> {{ publication.location }}
          </p>

          <hr />

          <div class="d-flex gap-3">
            <div class="flex-grow-1 me-3">
              <h6>Lo que tenés que saber de este producto:</h6>
              <p class="text-dark" style="font-size: 0.8rem;">- {{ publication.description }}</p>
            </div>
            <div style="min-width: 180px;">
              <h6 class="mb-2">Contactar al vendedor</h6>
              <div class="d-flex flex-column gap-2">
                <ng-container *ngFor="let contact of publication.contacts">
                  <a
                    [href]="getContactLink(contact)"
                    target="_blank"
                    rel="noopener"
                    class="contact-link d-flex align-items-center text-decoration-none"
                  >
                    <i [ngClass]="getContactIcon(contact.contact_type)" class="me-2"></i>
                    <span>{{ contact.contact_value }}</span>
                  </a>
                </ng-container>
              </div>
            </div>
          </div>
          <p class="text-secondary mb-1 mt-2" style="font-size: 0.7rem;">Fecha de publicación: {{ formatDate(publication.created_at) }}</p>
        </div>
      </div>

      <hr class="my-4" />

      <!-- Sección inferior: Vendedor + Reseñas -->
      <div class="row">
        <div class="col-12">

          <!-- Información del vendedor -->
          <div class="user-info mb-4">
            <h5>Información del vendedor</h5>
            <div class="d-flex align-items-center mb-2">
              <div class="avatar-perfil me-3">
                <img *ngIf="publication.user.avatar_url; else initials" [src]="publication.user.avatar_url" alt="Avatar" class="img-avatar">
                <ng-template #initials>
                  <div class="avatar-initials">
                    {{ getInitials(publication.user.name, publication.user.surname) }}
                  </div>
                </ng-template>
              </div>
              <div>
                <div class="d-flex align-items-center">
                  <strong class="me-2">{{ publication.user.name }} {{ publication.user.surname }}</strong>
                  <i *ngIf="publication.user.verified" class="bi bi-patch-check-fill text-info"></i>
                </div>
                <div class="d-flex align-items-center"></div>
                  <ng-container *ngFor="let star of [].constructor(5); let i = index">
                  <i [ngClass]="getStarClass(publication.user.rating, i)"></i>
                  </ng-container>
                  <span class="text-secondary ms-2" style="font-size: 0.7rem; color: gray;">({{publication.user.rating}})</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Reseñas -->
          <div class="user-reviews mb-2">
            <h6>Últimas reseñas</h6>
            <div *ngIf="(ratings?.length || 0) > 0; else noReviews">
              <div *ngFor="let rating of ratings | slice:0:reviewsToShow" class="border rounded p-2 m-1">
                <div class="d-flex justify-content-between">
                  <p style="margin: 0;">{{ rating.rater_user.name }} {{ rating.rater_user.surname }}</p>
                  <small style="margin: 0;">{{ formatDate(rating.created_at) }}</small>
                </div>
                <div class="mb-2">
                  <ng-container *ngFor="let star of [].constructor(5); let i = index">
                    <i [ngClass]="getStarClass(rating.rating, i)"></i>
                  </ng-container>
                </div>
                <p class="mb-0">{{ rating.comment }}</p>
              </div>

              <div *ngIf="ratings.length > reviewsToShow" class="text-end mt-1">
                <small 
                  style="color: gray; cursor: pointer; user-select: none;" 
                  (click)="loadMore()">
                  Ver más
                </small>
              </div>
            </div>

            <ng-template #noReviews>
              <p class="text-muted">Este vendedor aún no tiene reseñas.</p>
            </ng-template>
          </div>
          <hr class="mt-3">

          @if (userLoged.id != publication.user.id) {
            @if (existingRating != null) {
              <div class="existing-review mb-4">
              <h6>Tu reseña a este usuario:</h6>
              <div class="border rounded p-2">
                <div class="d-flex justify-content-between">
                <p style="margin: 0;">{{ existingRating.rater_user.name }} {{ existingRating.rater_user.surname }}</p>
                <small style="margin: 0;">{{ formatDate(existingRating.created_at) }}</small>
                </div>
                <div class="mb-2">
                <ng-container *ngFor="let star of [].constructor(5); let i = index">
                  <i [ngClass]="getStarClass(existingRating.rating, i)"></i>
                </ng-container>
                </div>
                <p class="mb-0">{{ existingRating.comment }}</p>
              </div>
              </div>
            }
            @else {
          <div class="add-review">
            <h6>Enviar una reseña</h6>
            <form (ngSubmit)="submitRating()" #ratingForm="ngForm">
              <div class="mb-2">
                <div class="d-flex">
                  <ng-container *ngFor="let i of [0, 1, 2, 3, 4]">
                    <i
                      class="bi"
                      [ngClass]="getStarClass(hoveredRating || newRating.rating, i)"
                      (mousemove)="onHover(i, $event)"
                      (mouseleave)="onLeave()"
                      (click)="setRating(i, $event)"
                      style="font-size: 1.8rem; cursor: pointer; margin-right: 4px;"></i>
                  </ng-container>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">Comentario:</label>
                <textarea class="form-control" [(ngModel)]="newRating.comment" name="comment" rows="3" required></textarea>
              </div>

              <div class="text-end">
                <button type="submit" class="btn btn-primary" [disabled]="ratingForm.invalid">Enviar reseña</button>
              </div>
            </form>
          </div>
            }
        }

        </div>
      </div>

    </div>
    <div *ngIf="selectedImage" class="custom-lightbox" (click)="closeImage()">
      <img [src]="selectedImage" class="lightbox-img" />
    </div>
  </div>
  <div
  #liveToast
  class="toast align-items-center border-0 position-fixed"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  style="bottom: 1rem; left: 50%; transform: translateX(-50%); min-width: 300px;"
>
  <div class="d-flex">
    <div class="toast-body">{{ toastMessage }}</div>
    <button
      type="button"
      class="btn-close btn-close-white me-2 m-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
      (click)="hideToast()"
    ></button>
  </div>
</div>


